<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü–∞–¥–∞—é—â–∏–µ –±–ª–æ–∫–∏</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      overflow: hidden;
      transition: background 1.2s ease; /* –ø–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ —Ñ–æ–Ω–∞ */
    }

    #game {
      position: relative;
      width: 400px;
      height: 600px;
      background: 
        radial-gradient(circle at 20% 30%, rgba(100, 200, 255, 0.15), transparent 25%),
        radial-gradient(circle at 80% 70%, rgba(255, 100, 200, 0.15), transparent 30%);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      margin-top: 20px;
      transition: background 1s ease;
    }

    .column {
      position: absolute;
      width: 100px;
      height: 100%;
      top: 0;
    }
    .column:nth-child(1) { left: 0; }
    .column:nth-child(2) { left: 100px; }
    .column:nth-child(3) { left: 200px; }
    .column:nth-child(4) { left: 300px; }

    .square {
      position: absolute;
      width: 80px;
      border-radius: 8px;
      top: -200px;
      left: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      user-select: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: transform 0.1s, opacity 0.3s;
    }
    .square:hover { transform: scale(1.04); }
    /* –¶–≤–µ—Ç–∞ –∑–∞–¥–∞—ë–º —á–µ—Ä–µ–∑ JS, –ø–æ—ç—Ç–æ–º—É –±–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –±–µ–∑ —Ñ–æ–Ω–∞ */

    #ui {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 400px;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    }
    #sound-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #sound-btn:hover { color: #bbdefb; }

    #game-over {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 32px;
      display: none;
      z-index: 10;
      border-radius: 12px;
    }
    #restart-btn {
      margin-top: 24px;
      padding: 12px 28px;
      font-size: 18px;
      background: linear-gradient(to right, #66bb6a, #43a047);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(102, 187, 106, 0.5);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #restart-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(102, 187, 106, 0.7);
    }
  </style>
</head>
<body>
  <div id="ui">
    <div>–°—á—ë—Ç: <span id="score">0</span></div>
    <div>–ü—Ä–æ–º–∞—Ö–∏: <span id="misses">0</span>/2</div>
    <button id="sound-btn">üîä</button>
  </div>

  <div id="game">
    <div class="column"></div>
    <div class="column"></div>
    <div class="column"></div>
    <div class="column"></div>
    <div id="game-over">
      –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!<br>
      –í–∞—à —Å—á—ë—Ç: <span id="final-score">0</span>
      <button id="restart-btn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
  </div>

  <audio id="bg-music" loop>
    <source src="https://cdn.pixabay.com/audio/2022/03/10/audio_5655f7a5b6.mp3" type="audio/mpeg">
  </audio>

  <script>
    const body = document.body;
    const gameArea = document.getElementById('game');
    const columns = document.querySelectorAll('.column');
    const scoreEl = document.getElementById('score');
    const missesEl = document.getElementById('misses');
    const gameOverScreen = document.getElementById('game-over');
    const finalScoreEl = document.getElementById('final-score');
    const restartBtn = document.getElementById('restart-btn');
    const soundBtn = document.getElementById('sound-btn');
    const bgMusic = document.getElementById('bg-music');

    // –ü–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤
    const normalColors = ['#4CAF50', '#66BB6A', '#2E7D32', '#81C784'];
    const longColors = ['#FF9800', '#FF5722', '#E64A19', '#FB8C00', '#D84315'];
    const holdColors = ['#2196F3', '#03A9F4', '#0288D1', '#4FC3F7', '#00BCD4'];

    // –§–æ–Ω—ã (–≥—Ä–∞–¥–∏–µ–Ω—Ç—ã)
    const backgrounds = [
      'linear-gradient(135deg, #0f0c29, #302b63, #24243e)',      // 0‚Äì4
      'linear-gradient(135deg, #16222A, #3A6073)',                // 5‚Äì9
      'linear-gradient(135deg, #4B6CB7, #182848)',                // 10‚Äì14
      'linear-gradient(135deg, #834d9b, #d04ed6)',                // 15‚Äì19
      'linear-gradient(135deg, #ff7e5f, #feb47b)'                 // 20+
    ];

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    const baseWidth = 80;
    const normalHeight = 80;
    const longHeight = 140;
    const initialFallDuration = 5000;
    const minFallDuration = 2000;
    const speedUpEvery = 3;
    const holdTime = 800;
    const maxMisses = 2;
    const bgChangeEvery = 5; // —Ñ–æ–Ω –º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –æ—á–∫–æ–≤

    let score = 0;
    let misses = 0;
    let gameActive = true;
    let spawnInterval = null;
    let currentFallDuration = initialFallDuration;
    let isMuted = false;

    function updateUI() {
      scoreEl.textContent = score;
      missesEl.textContent = misses;
    }

    function updateBackground() {
      const bgIndex = Math.min(Math.floor(score / bgChangeEvery), backgrounds.length - 1);
      body.style.background = backgrounds[bgIndex];
    }

    function maybeIncreaseSpeed() {
      if (score > 0 && score % speedUpEvery === 0) {
        const newDuration = Math.max(minFallDuration, initialFallDuration - Math.floor(score / speedUpEvery) * 400);
        if (newDuration < currentFallDuration) {
          currentFallDuration = newDuration;
        }
      }
      updateBackground(); // –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω –ø—Ä–∏ —Ä–æ—Å—Ç–µ —Å—á—ë—Ç–∞
    }

    function getRandomColor(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function spawnSquare() {
      if (!gameActive) return;

      const randomCol = Math.floor(Math.random() * 4);
      const square = document.createElement('div');
      square.className = 'square';

      const r = Math.random();
      let height, bgColor;
      if (r < 0.6) {
        height = normalHeight;
        bgColor = getRandomColor(normalColors);
      } else if (r < 0.8) {
        height = longHeight;
        bgColor = getRandomColor(longColors);
      } else {
        height = normalHeight;
        bgColor = getRandomColor(holdColors);
        square.textContent = '‚úî';
      }

      square.style.height = height + 'px';
      square.style.background = bgColor;

      let holdActive = false;
      let holdComplete = false;

      const startHold = () => {
        if (holdActive || r >= 0.8) return; // —Ç–æ–ª—å–∫–æ hold-–±–ª–æ–∫–∏ (r >= 0.8)
        holdActive = true;
        const holdStartTime = Date.now();
        const updateHold = () => {
          if (!holdActive || !gameActive || !square.parentNode) return;
          const elapsed = Date.now() - holdStartTime;
          const progress = Math.min(elapsed / holdTime, 1);
          square.style.opacity = 1 - progress * 0.7;
          if (elapsed < holdTime) {
            requestAnimationFrame(updateHold);
          } else {
            holdComplete = true;
            square.remove();
            score++;
            updateUI();
            maybeIncreaseSpeed();
          }
        };
        requestAnimationFrame(updateHold);
      };

      const endHold = () => {
        holdActive = false;
        if (square.parentNode && !holdComplete) {
          square.style.opacity = 1;
        }
      };

      if (r >= 0.8) {
        // Hold-–±–ª–æ–∫
        square.addEventListener('mousedown', (e) => { startHold(); e.preventDefault(); });
        square.addEventListener('mouseup', endHold);
        square.addEventListener('mouseleave', endHold);
        square.addEventListener('touchstart', (e) => { startHold(); e.preventDefault(); });
        square.addEventListener('touchend', endHold);
        square.addEventListener('touchcancel', endHold);
      } else {
        // –û–±—ã—á–Ω—ã–π –∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–π
        const onClick = () => {
          if (square.parentNode) {
            square.remove();
            score++;
            updateUI();
            maybeIncreaseSpeed();
          }
        };
        square.addEventListener('mousedown', onClick);
        square.addEventListener('touchstart', (e) => { onClick(); e.preventDefault(); });
      }

      columns[randomCol].appendChild(square);

      let startTime = null;
      const animate = (timestamp) => {
        if (!startTime) startTime = timestamp;
        if (!gameActive || !square.parentNode) return;

        const elapsed = timestamp - startTime;
        const progress = Math.min(elapsed / currentFallDuration, 1);
        const topPos = progress * (gameArea.offsetHeight - height);
        square.style.top = topPos + 'px';

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          if (square.parentNode) {
            square.remove();
            misses++;
            updateUI();
            if (misses >= maxMisses) {
              endGame();
            }
          }
        }
      };
      requestAnimationFrame(animate);
    }

    // --- –ê—É–¥–∏–æ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ---
    function initAudio() {
      if (bgMusic.paused) {
        bgMusic.volume = 0.3;
        bgMusic.play().catch(e => console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ"));
      }
    }

    soundBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      bgMusic.muted = isMuted;
      soundBtn.textContent = isMuted ? 'üîá' : 'üîä';
    });

    function endGame() {
      gameActive = false;
      finalScoreEl.textContent = score;
      gameOverScreen.style.display = 'flex';
    }

    function startGame() {
      if (spawnInterval) clearInterval(spawnInterval);
      score = 0;
      misses = 0;
      gameActive = true;
      currentFallDuration = initialFallDuration;
      updateUI();
      updateBackground(); // —Å–±—Ä–æ—Å —Ñ–æ–Ω–∞
      gameOverScreen.style.display = 'none';
      document.querySelectorAll('.square').forEach(el => el.remove());
      spawnInterval = setInterval(spawnSquare, 1000);
      initAudio();
    }

    restartBtn.addEventListener('click', startGame);
    startGame();
  </script>
</body>
</html>